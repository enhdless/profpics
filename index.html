<!doctype>
<html>

<head>
	<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<link rel="stylesheet" href="style.css">
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/camanjs/4.0.0/caman.full.min.js"></script>
	 <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v5.0.2.min.js"></script>
	 <title>2017 Profile Pictures!</title>
</head>

<body>

	<h1>2017 Homecoming Profile Pictures!</h1>
<div class="container">
	<div class="main">
		<canvas id="img" width=600 height=600></canvas>
	</div>

	<div class="side">
		<h3>1.) Upload</h3>
		<b>Upload a picture of yourself!</b>
		<input type="file" id="imageLoader" name="imageLoader" >
		<br><br>
		If you wish to try a different one, refresh the page.
		<br><br>

		<h3>2.) Edit Image</h3>
		Move: 
		<button class="btn edit" id="up" disabled><i class="fa fa-arrow-up fa-fw"></i></button>
		<button class="btn edit" id="down" disabled><i class="fa fa-arrow-down fa-fw"></i></button>
		<button class="btn edit" id="left" disabled><i class="fa fa-arrow-left fa-fw"></i></button>
		<button class="btn edit" id="right" disabled><i class="fa fa-arrow-right fa-fw"></i></button>
		<br>
		Rotate:
		<button class="btn edit" id="rot-l" disabled><i class="fa fa-rotate-left fa-fw"></i></button>
		<button class="btn edit" id="rot-r" disabled><i class="fa fa-rotate-right fa-fw"></i></button>
		<br>
		Change size:
		<button class="btn edit" id="bigger" disabled><i class="fa fa-plus fa-fw"></i></button>
		<button class="btn edit" id="smaller" disabled><i class="fa fa-minus fa-fw"></i></button>


		<h3>3.) Done?</h3>
		<a href="#" class="btn" id="btn-download">Download!</a>
		<br><br>

		<h3>Something weird happen?</h3>
		<a href="/" class='btn'>Refresh the page!</a>

	</div>


</div>


</body>

</html>

<script>
var imageLoader = document.getElementById('imageLoader');
    imageLoader.addEventListener('change', handleImage, false);
var canvas = document.getElementById('img');
var ctx = canvas.getContext('2d');

var frame = new Image();
frame.src = 'hc2014.png';
frame.onload = function(){
	ctx.drawImage(frame,0,0,600,600);
}

var img;
var imgX = 85;
var imgY = 163;
var imgRot = 0;
var r = 430;
function handleImage(e){
	$('.edit').removeAttr('disabled');
	canvas.width = 600;
    var reader = new FileReader();
    reader.onload = function(event){
        img = new Image();
        img.onload = function(){
            ctx.drawImage(img,imgX,imgY,r,img.height*r/img.width);
			ctx.drawImage(frame,0,0,600,600); 
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(e.target.files[0]); 
}


$('#up').on('click',function() {
	if (imgRot==0) imgY -= 10;
	if (imgRot==90 || imgRot==-270) imgX -= 10;
	if (imgRot==180 || imgRot==-180) imgY += 10;
	if (imgRot==270 || imgRot==-90) imgX += 10;
	redraw();
});
$('#down').on('click',function() {
	if (imgRot==0) imgY += 10;
	if (imgRot==90 || imgRot==-270) imgX += 10;
	if (imgRot==180 || imgRot==-180) imgY -= 10;
	if (imgRot==270 || imgRot==-90) imgX -= 10;
	redraw();
});
$('#left').on('click',function() {
	if (imgRot==0) imgX -= 10;
	if (imgRot==90 || imgRot==-270) imgY += 10;
	if (imgRot==180 || imgRot==-180) imgX += 10;
	if (imgRot==270 || imgRot==-90) imgY -= 10;
	redraw();
});
$('#right').on('click',function() {
	if (imgRot==0) imgX += 10;
	if (imgRot==90 || imgRot==-270) imgY -= 10;
	if (imgRot==180 || imgRot==-180) imgX -= 10;
	if (imgRot==270 || imgRot==-90) imgY += 10;
	redraw();
});
$('#rot-r').on('click',function() {
	imgRot = imgRot==270 ? 0 : imgRot+=90;
	redraw();
});
$('#rot-l').on('click',function() {
	imgRot = imgRot==-270 ? 0 : imgRot-=90;
	redraw();
});
$('#bigger').on('click',function() {
	r += 10;
	redraw();
});
$('#smaller').on('click',function() {
	r -= 10;
	redraw();
});

function redraw() {
	canvas.width = 600;
	ctx.save();
	ctx.translate(300,300);
	ctx.rotate(imgRot*Math.PI/180);
    ctx.drawImage(img,-300+imgX,-300+imgY,r,img.height*r/img.width);
    ctx.restore();
	ctx.drawImage(frame,0,0,600,600); 
	done = 0;

}

done = 0;
var button = document.getElementById('btn-download');
button.addEventListener('click', function (e) {
	if(!done) {
		Caman("#img", function () {
			this.saturation(0);
			this.sepia(50).render();
		});
	}
	if (done==2) {
		console.log('asdf');
		var dataURL = canvas.toDataURL('image/png');
	    button.href = dataURL;
	    button.download = "profile.png";
	}
});


Caman.Event.listen("processComplete", function (job) {
	console.log("Finished:", job.name);
	done++;
	if (done==2) {
		setTimeout(function() {
			button.click();
		},500);	
	}
});




</script>